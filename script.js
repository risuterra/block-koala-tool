const ign={p:"player",a:"tile_a",b:"tile_b",c:"tile_c",0:"null",1:"red_1",2:"red_2",3:"red_3",4:"red_4",5:"block_5",6:"black_1",7:"black_2",8:"black_3",9:"black_4",d:"blue_1",e:"blue_2",f:"blue_3",g:"blue_4",l:"rocks",h:"up",i:"down",j:"left",k:"right",m:"door",n:"key",o:"clone",q:"star_space",r:"star_block"};let jsd,lls=[[],[],[],[],[],[],[],[]],fileSlot=1;function elb(e){const t=document.getElementById(`b${e}`);t&&(t.disabled=!1,t.style.cursor="pointer",t.addEventListener("click",(function(){sel(e)})))}function sel(e){targetLevel=lls[e-51],document.getElementById("svs").value=e,document.getElementById("lvi").value=targetLevel.flat().join(""),ldlv(targetLevel)}function ldlv(e){const t=document.getElementById("gc");t.innerHTML="",e.forEach((e=>{e.forEach((e=>{const l=document.createElement("div");l.className="tl",l.innerHTML=`<img class="${e.toLowerCase()}" src="assets/tile/${ign[e.toLowerCase()]}.png"/>`,t.appendChild(l)}))}))}function dab(){lls=[[],[],[],[],[],[],[],[]];document.querySelectorAll(".lvc button").forEach((e=>{e.disabled=!0,e.style.cursor="not-allowed"}))}function cl(e){for(var t="",l=0;l<e.length;l++)e.charCodeAt(l)>0&&(t+=e.charAt(l));return t}function sta(e){if(192!==e.length)throw new Error("Input string must be exactly 192 characters long.");let t=[];for(let l=0;l<12;l++){const n=e.slice(16*l,16*(l+1)).split("");t.push(n)}return t}function vin(e){if(192!==e.length)return"Not long enough.";if(!/^[A-R0-9]+$/.test(e))return"Contains invalid characters.";if(1!=(e.match(/P/g)||[]).length)return"Should only have 1 player character.";const t=sta(e);for(let e=0;e<12;e++)if("B"===t[e][15]||"C"===t[e][15]||"C"===t[e][14])return"Invalid 2x2 or 3x3 tile placement.";for(let e=0;e<16;e++)if("B"===t[11][e]||"C"===t[11][e]||"C"===t[10][e])return"Invalid 2x2 or 3x3 tile placement.";for(let e=0;e<11;e++)for(let l=0;l<15;l++)if("B"===t[e][l]&&("0"!==t[e+1][l]||"0"!==t[e][l+1]||"0"!==t[e+1][l+1]))return"Tiles should not overlap 2x2 tiles.";for(let e=0;e<10;e++)for(let l=0;l<14;l++)if("C"===t[e][l])for(let n=0;n<3;n++)for(let o=0;o<3;o++)if("0"!==t[e+n][l+o]&&(0!==n||0!==o))return"Tiles should not overlap 3x3 tiles.";return"Valid"}document.getElementById("cpb").addEventListener("click",(function(){let e=document.getElementById("lvi");if(console.log(e.value),e.focus(),e.select(),navigator.clipboard)return navigator.clipboard.writeText(e.value);document.execCommand("copy")})),document.getElementById("lvi").addEventListener("input",(function(){let e=document.getElementById("lvi").value.trim().toUpperCase();if("Valid"==vin(e)){document.getElementById("lvi").value=e;ldlv(sta(e))}})),document.getElementById("dl").addEventListener("click",(function(){if(!jsd)return alert("Must load a valid UFO save file first.");for(let e=0;e<8;e++){jsd[`game18_customLevel${e+51}`]&&delete jsd[`game18_customLevel${e+51}`];const t=lls[e]?lls[e].flat().join(""):"";t.length>0&&(jsd[`game18_customLevel${e+51}`]=t)}let e=btoa(JSON.stringify(jsd))+"\0";const t=document.createElement("a"),l=new Blob([e],{type:"text/plain"});t.href=URL.createObjectURL(l),t.download=`save${fileSlot}.ufo`,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)})),document.getElementById("sb").addEventListener("click",(function(){const e=document.getElementById("lvi").value.trim().toUpperCase();if("Valid"==vin(e)){const t=document.getElementById("svs").value;lls[t-51]=sta(e),elb(t)}else alert("Invalid input. Cannot save to slot.")})),document.getElementById("clb").addEventListener("click",(function(){const e=document.getElementById("svs").value;lls[e-51]=[];const t=document.getElementById(`b${e}`);t&&(t.disabled=!0,t.style.cursor="not-allowed")})),document.getElementById("fi").addEventListener("change",(function(e){const t=e.target.files[0];if(!t||!t.name.endsWith(".ufo"))return void("Save Uploaded"!=document.getElementById("fn").innerText?document.getElementById("fn").innerText="Invalid File":alert("Rejecting uploaded file. Must be a .ufo file."));switch(t.name){case"save2.ufo":fileSlot=2;break;case"save3.ufo":fileSlot=3;break;default:fileSlot=1}document.getElementById("fn").innerText="Save Uploaded";const l=new FileReader;l.onload=function(e){try{let t=e.target.result;t=cl(t);const l=atob(t);dab(),jsd=JSON.parse(l);for(let e=51;e<=60;e++)jsd[`game18_customLevel${e}`]&&192==jsd[`game18_customLevel${e}`].length&&(lls[e-51]=sta(jsd[`game18_customLevel${e}`]),elb(e))}catch(e){alert("Invalid data: Failed to decode or parse the UFO file."),document.getElementById("fn").innerText="Invalid File",console.error(e)}},l.readAsText(t)}));